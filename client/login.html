<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula Drive - Connexion</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="login-page">
        <div class="login-container">
            <div class="login-card">
                <!-- Header avec logo -->
                <div class="login-header">
                    <div class="login-logo">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                        </svg>
                    </div>
                    <h1 class="login-title">Nebula Drive</h1>
                    <p class="login-subtitle">Votre espace de stockage personnel et s√©curis√©</p>
                </div>
                
                <!-- ‚úÖ INDICATEUR DE STATUT SERVEUR -->
                <div style="padding: 0 40px 20px 40px;">
                    <div id="server-status-indicator" style="text-align: center;">
                        <span style="display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; padding: 8px 16px; border-radius: 8px; background: #6b728015; color: #6b7280; font-weight: 500;">
                            <span style="font-size: 1rem;">üîç</span>
                            V√©rification serveur...
                        </span>
                    </div>
                    <div id="server-help-text" style="display: none; margin-top: 8px; text-align: center; font-size: 0.8rem; color: var(--accent-warning);"></div>
                    <!-- ‚úÖ Bouton de d√©connexion si session existante -->
<div id="existing-session-warning" style="display: none; padding: 0 40px 20px 40px;">
    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--accent-warning); border-radius: 12px; padding: 16px; text-align: center;">
        <p style="color: var(--accent-warning); font-weight: 600; margin-bottom: 12px;">
            ‚ö†Ô∏è Une session est d√©j√† active
        </p>
        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
            Vous √™tes actuellement connect√© en tant que <strong id="current-session-user"></strong>
        </p>
        <button onclick="forceLogout()" class="btn btn-danger" style="width: 100%;">
            D√©connecter et utiliser un autre compte
        </button>
    </div>
</div>
                </div>

                <!-- Body avec formulaires -->
                <div class="login-body">
                    <!-- Tabs -->
                    <div class="login-tabs">
                        <button class="login-tab active" data-tab="login">Connexion</button>
                        <button class="login-tab" data-tab="register">Inscription</button>
                    </div>
                    
                    <!-- Formulaire Connexion -->
                    <form id="login-form" class="login-form active">
                        <div id="login-error" class="alert alert-error" style="display: none;"></div>
                        
                        <div class="form-group">
                            <label class="form-label" for="login-identifier">Nom d'utilisateur ou Email</label>
                            <input type="text" 
                                   id="login-identifier" 
                                   class="form-input" 
                                   placeholder="Entrez votre identifiant"
                                   required
                                   autocomplete="username">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="login-password">Mot de passe</label>
                            <input type="password" 
                                   id="login-password" 
                                   class="form-input" 
                                   placeholder="Entrez votre mot de passe"
                                   required
                                   autocomplete="current-password">
                        </div>
                        
                        <button type="submit" id="login-submit-btn" class="btn btn-primary" style="width: 100%;">
                            Se connecter √† ND
                        </button>
                        
                        <div class="login-footer">
                            <a href="#" onclick="openForgotPasswordModal(); return false;">Mot de passe oubli√© ?</a>
                        </div>
                    </form>
                    
                    <!-- Formulaire Inscription -->
                    <form id="register-form" class="login-form">
                        <div id="register-error" class="alert alert-error" style="display: none;"></div>
                        <div id="register-success" class="alert alert-success" style="display: none;"></div>
                        
                        <div class="form-group">
                            <label class="form-label" for="register-username">Nom d'utilisateur</label>
                            <input type="text" 
                                   id="register-username" 
                                   class="form-input" 
                                   placeholder="Choisissez un nom d'utilisateur"
                                   required
                                   minlength="3"
                                   autocomplete="username">
                            <p class="form-hint">Minimum 3 caract√®res</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="register-email">Email</label>
                            <input type="email" 
                                   id="register-email" 
                                   class="form-input" 
                                   placeholder="jordan@nebuladrive.net"
                                   required
                                   autocomplete="email">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="register-password">Mot de passe</label>
                            <input type="password" 
                                   id="register-password" 
                                   class="form-input" 
                                   placeholder="Choisissez un mot de passe"
                                   required
                                   minlength="6"
                                   autocomplete="new-password">
                            <p class="form-hint">Minimum 6 caract√®res</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="register-confirm">Confirmer le mot de passe</label>
                            <input type="password" 
                                   id="register-confirm" 
                                   class="form-input" 
                                   placeholder="Confirmez votre mot de passe"
                                   required
                                   autocomplete="new-password">
                        </div>
                        
                        <button type="submit" id="register-submit-btn" class="btn btn-primary" style="width: 100%;">
                            Cr√©er mon compte Nebula Drive
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Info serveur -->
            <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent-primary); flex-shrink: 0;">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <div style="flex: 1;">
                        <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 0.9rem;">S√©curit√© & Conformit√©</p>
                        <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5;">
                            ‚úì Donn√©es chiffr√©es (AES-256) ‚Ä¢ ‚úì Connexions HTTPS s√©curis√©es<br>
                            ‚úì Tra√ßabilit√© compl√®te des actions ‚Ä¢ ‚úì Conformit√© RGPD
                        </p>
                    </div>
                </div>
            </div>
    
    <!-- Modal Mot de passe oubli√© -->
    <div id="forgot-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">R√©initialisation de Mot de passe</h3>
                <button class="modal-close" onclick="closeModal('forgot-modal')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="forgot-error" class="alert alert-error" style="display: none;"></div>
                <div id="forgot-success" class="alert alert-success" style="display: none;"></div>
                
                <div class="form-group">
                    <label class="form-label" for="forgot-email">Email</label>
                    <input type="email" 
                           id="forgot-email" 
                           class="form-input" 
                           placeholder="Entrez votre email">
                    <p class="form-hint">Un lien de r√©initialisation sera envoy√© √† cette adresse.</p>
                </div>
                  <!-- ‚úÖ EXPLICATION DU PROCESSUS -->
                <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-top: 16px;">
                    <p style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">
                        ‚ÑπÔ∏è Comment √ßa fonctionne :
                    </p>
                    <ul style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 20px; line-height: 1.6;">
                        <li>Votre demande sera envoy√©e √† un administrateur</li>
                        <li>L'administrateur validera votre identit√©</li>
                        <li>Un nouveau mot de passe temporaire vous sera envoy√© par email</li>
                        <li><strong>D√©lai de traitement : 24 √† 48 heures max</strong></li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('forgot-modal')">Annuler</button>
                <button class="btn btn-primary" onclick="requestPasswordReset()">Envoyer</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- √Ä ajouter dans le footer de login.html --> 
     <div class="login-footer"> 
        <p> En vous inscrivant, vous acceptez nos 
            <a href="terms.html" target="_blank">
                Conditions d'Utilisation
            </a> 
            et notre 
            <a href="privacy.html" target="_blank">
                Politique de Confidentialit√©
            </a>. 
        </p> 
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script>


        // Afficher l'URL du serveur
        //document.getElementById('server-url').textContent = CONFIG.API_URL;
        
         // ========================================
        // GESTION DU LOGIN (Sans balise form)
        // ========================================
        
        function handleLogin() {
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            
            errorDiv.style.display = 'none';
            
            if (!identifier || !password) {
                errorDiv.textContent = '‚ùå Veuillez remplir tous les champs.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (AppState.serverStatus !== 'connected') {
                errorDiv.textContent = '‚ùå Connexion impossible : le serveur est actuellement hors ligne. Veuillez patienter pendant que nous tentons de r√©tablir la connexion.';
                errorDiv.style.display = 'block';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0 auto;"></div>';
            
            auth.login(identifier, password)
                .then(() => {
                    showToast('success', '‚úÖ Connexion r√©ussie', 'Bienvenue dans Nebula Drive !');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 500);
                })
                .catch(error => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Se connecter √† Nebula Drive';
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                    showToast('error', 'Erreur de connexion', error.message);
                });
        }
        
        function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            const errorDiv = document.getElementById('register-error');
            const successDiv = document.getElementById('register-success');
            const submitBtn = document.getElementById('register-submit-btn');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (!username || !email || !password || !confirm) {
                errorDiv.textContent = '‚ùå Veuillez remplir tous les champs.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password !== confirm) {
                errorDiv.textContent = '‚ùå Les mots de passe ne correspondent pas.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (AppState.serverStatus !== 'connected') {
                errorDiv.textContent = '‚ùå Service d\'inscription temporairement indisponible (serveur hors ligne).';
                errorDiv.style.display = 'block';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0 auto;"></div>';
            
            auth.register(username, email, password)
                .then(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Cr√©er mon compte Nebula Drive';
                    successDiv.textContent = '‚úÖ Inscription r√©ussie ! Vous pouvez maintenant vous connecter avec vos identifiants.';
                    successDiv.style.display = 'block';
                    showToast('success', 'Inscription r√©ussie', 'Vous pouvez maintenant vous connecter');
                    
                    setTimeout(() => {
                        document.querySelector('[data-tab="login"]').click();
                        document.getElementById('login-identifier').value = username;
                    }, 1500);
                })
                .catch(error => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Cr√©er mon compte Nebula Drive';
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                    showToast('error', 'Erreur d\'inscription', error.message);
                });
        }
        
        // Enter key support
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        
        document.getElementById('register-confirm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });


        // Modal mot de passe oubli√©
        function openForgotPasswordModal() {
            document.getElementById('forgot-email').value = '';
            document.getElementById('forgot-error').style.display = 'none';
            document.getElementById('forgot-success').style.display = 'none';
            openModal('forgot-modal');
        }
        
        async function requestPasswordReset() {
            const email = document.getElementById('forgot-email').value;
            const errorDiv = document.getElementById('forgot-error');
            const successDiv = document.getElementById('forgot-success');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (!email) {
                errorDiv.textContent = '‚ùåVeuillez entrer votre email';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (AppState.serverStatus !== 'connected') {
                errorDiv.textContent = '‚ùå Service temporairement indisponible (serveur hors ligne).';
                errorDiv.style.display = 'block';
                return;
            }

          try {
                const result = await api.forgotPassword(email);
                successDiv.innerHTML = `‚úÖ ${result.message || 'Demande envoy√©e avec succ√®s !'}<br><br><small>Un administrateur va examiner votre requ√™te et vous enverra un nouveau mot de passe par email dans un d√©lai de 24 √† 48 heures ouvr√©es.</small>`;
                successDiv.style.display = 'block';
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>